# Gemini Sub-agents Spec

本ドキュメントでは、Gemini CLI 拡張機能における「サブエージェント（Sub-agents）」の定義、配置、および実戦的な運用設計について記述する。

---

## 1. 必須設定 (Hidden Configuration)

カスタム・サブエージェントを有効にするには、ユーザーの `settings.json` において以下の設定が必須である。本機能は現在実験的なフェーズにあるため、**`/settings` コマンドの UI 画面には表示されず、ファイルを直接編集して追記する必要がある**点に注意せよ。

### 設定内容
`~/.gemini/settings.json` にて、`experimental` セクションに以下のフラグを追記せよ：

```json
{
  "experimental": {
    "enableAgents": true
  }
}
```

---

## 2. ディレクトリ構造と自動認識

サブエージェントは、拡張機能ルートの `agents/` ディレクトリ配下に配置された Markdown (`.md`) ファイルとして定義される。

### 配置ルール
- **自動検出**: `agents/` 内のファイルは CLI 起動時に自動スキャンされる。
- **マニフェスト不要**: **`gemini-extension.json` への登録は一切不要**である。過去に登録が必要と誤解された経緯があるが、現在はディレクトリ配置のみがトリガーとなる。

---

## 3. エージェント定義ファイル (.md) の構成

ファイルは YAML フロントマターと、それに続くシステムプロンプト（指示書）で構成される。

### フロントマター (YAML)
```yaml
---
name: agent-name
description: >
  エージェントの役割の簡潔な説明。
  メインエージェントが「いつこのサブエージェントに委譲すべきか」を判断する材料となる。
tools:
  - read_file
  - write_file
  - activate_skill
---
```

- **`name`**: 一意の識別子。ユーザーが `@name` で呼び出す際の名称となる。
- **`tools` (重要)**: エージェントの使用を許可するツールのリスト。
    - **制約**: サブエージェントが使用できないツール（例: 他の高度なサブエージェント等）をリストに含めると、**ロードに失敗し CLI に認識されなくなる**ため、最小限かつ確実なツールのみを指定すること。

### プロンプト本文 (Instructions)
エージェントのペルソナ、ワークフロー、および「拘束条件」を記述する。

---

## 4. 実戦から得られた設計原則 (Lessons Learned)

本プロジェクトの開発（`v1.11.0`〜`v1.13.0`）を通じて確立された、サブエージェントを使いこなすための重要原則。

### A. 知識の動的ロード・パターン
プロンプトを肥大化させず、かつ最新の知識を適用するために、サブエージェントに **`activate_skill` を自律的に実行させる** ワークフローを組み込む。
- **例**: `issue-crafter` は開始直後に `prompt_crafter` スキルをロードし、設計原則（`agent-document-spec.md`）を自身のコンテキストに取り込む。

### B. 抽象語の徹底排除と事実ベースの強制
エージェントの「先走り」や「推測」を防ぐため、以下の制約をプロンプトに含めることが推奨される。
- **禁止語**: 「適切に」「必要に応じて」「など」といった曖昧な表現を一切禁止する。
- **証拠の義務化**: `read_file` や `grep_search` で確認した「具体的なコードやファイルパス」のみを根拠に回答することを義務付ける。

### C. 役割の分離（客観性の担保）
メインエージェントの「自己レビューの甘さ」を解消するため、`code-reviewer` のように **「独立したコンテキストと視点」** を持つサブエージェントに検証を委譲する構成が極めて有効である。

### D. 完了報告の構造化
サブエージェントの作業終了時、メインエージェントに対して「どのファイルを調査し、どの原則に従ったか」を具体的事実ベースで報告（Final Report）させる。これにより、委譲元が作業の品質を即座に判断できる。

---

## 5. 運用上の注意

- **ロード失敗のデバッグ**: `@name` で呼び出せない、または `available_subagents` に現れない場合は、まずフロントマターの `tools` リストに不正な（許可されていない）ツール名が含まれていないかを確認せよ。
- **コンテキストの継承**: サブエージェントは呼び出し時のプロジェクトコンテキストを継承するが、その思考は独立している。
