---
id: v1.12.0
type: fix
status: drafting
created: 2026-02-20
fixed_commit: 
---

# Issue: jules-client watch コマンドにおける過去イベントの誤検知修正

## 概要
`jules-client watch` コマンドにおいて、`--wait-for` オプションで指定したイベントが過去のセッション履歴（過去のアクティビティや既に完了した状態）に含まれている場合に、コマンド実行直後に「検知成功」と誤判定して終了してしまう問題を修正する。

## 背景と問題点
現在の `watchSession` 実装（`skills/jules-client/scripts/api.cjs`）には以下の問題がある。

1. **時間軸フィルタリングの欠如**: ポーリング時に API から返される最大 50 件のアクティビティをすべて走査し、`seenActivityIds`（実行ごとに初期化される既読フラグ）にないものを処理する。このため、コマンド起動前に発生した過去の `plan` や `changes` が存在すると、即座にそれらを「新しいイベント」として検知してしまう。
2. **状態の即時終了判定**: `waitFor === 'finish'` の場合、アクティビティの走査とは別に、現在のセッション状態（`session.state`）が `COMPLETED`, `FAILED`, `CANCELLED` のいずれかであれば即座に終了判定を下す。これにより、既に完了したセッションに対して「次の完了」を待機することができない。
3. **オプションの比較不備**: `--wait-for` に指定された文字列とアクティビティの種別を比較する際、大文字小文字が区別される（例: `Plan` と指定すると `plan` イベントにマッチしない）。

## 解決策
1. **時間軸によるフィルタリング**: コマンド実行時の時刻 (`startTime`) を取得し、`activity.createTime` をパースした値が `startTime` 以降であるアクティビティのみをイベント検知（`conditionMet`）の対象とする。
2. **状態遷移の監視**: `waitFor === 'finish'` の判定において、起動時のセッション状態（`initialState`）を保持し、「非終端状態から終端状態への遷移」が発生した場合、または「起動時刻以降に発行された終端アクティビティ」を検知した場合のみ終了とする。
3. **入力の正規化**: `waitFor` オプションを小文字に正規化（`.toLowerCase()`）して比較を行う。

## 実装内容詳細

`skills/jules-client/scripts/api.cjs` 内の `watchSession` 関数を以下の通り修正する。

### 1. 変数初期化と正規化
関数の冒頭で以下を定義する。
- `const normalizedWaitFor = (options.waitFor || '').toLowerCase();`
- `const startTime = Date.now();` (ミリ秒精度の Unix Timestamp)
- `let lastState = null;` (状態遷移監視用)

### 2. 初期状態の取得
ループ開始前に現在のセッション状態を取得し、`lastState` を初期化する。
```javascript
try {
    const session = await request('GET', `/sessions/${pathId}`);
    lastState = session.state;
} catch (e) {
    // 取得失敗時は null のまま継続
}
```

### 3. アクティビティ判定ロジックの修正
ループ内のアクティビティ走査処理を以下のように変更する。
- `activity.createTime` (ISO 8601 文字列) を `new Date(act.createTime).getTime()` でミリ秒変換する。
- `const isNewActivity = activityTime >= startTime;` を判定。
- `checkCondition(act)` の呼び出し条件を `if (isNewActivity && checkCondition(act))` に変更する。
- `checkCondition` 内部では `normalizedWaitFor` を使用するように修正する。

### 4. セッション状態チェックの修正
ループ末尾の `if (waitFor === 'finish')` ブロックを以下のように変更する。
```javascript
if (normalizedWaitFor === 'finish') {
    const session = await request('GET', `/sessions/${pathId}`);
    const currentState = session.state;
    const terminalStates = ['COMPLETED', 'FAILED', 'CANCELLED'];
    
    // 状態が変化し、かつ変化後の状態が終端状態である場合のみ検知
    const isTransitionToTerminal = !terminalStates.includes(lastState) && terminalStates.includes(currentState);
    
    if (isTransitionToTerminal) {
        console.log(`[${new Date().toLocaleTimeString()}] [Status] Session transitioned to ${currentState}`);
        conditionMet = true;
    }
    lastState = currentState;
}
```

## ゴール
- **過去イベントの無視**: 過去に `plan` が生成済みのセッションに対し `watch --wait-for plan` を実行したとき、即座に終了せず待機し続けること。
- **次の完了の待機**: `COMPLETED` 状態のセッションに対し `watch --wait-for finish` を実行したとき、即座に終了せず待機すること。その後、新たなメッセージ送信によりセッションが動き出し、再度 `COMPLETED` になった時点で終了すること。
- **入力揺れの許容**: `--wait-for Plan` や `--wait-for FINISH` と指定しても正しく動作すること。
- **正常なログ出力**: アクティビティのログ出力自体は、文脈把握のため過去分（最大50件）も引き続き表示されるが、それによってプロセスが終了しないこと。
