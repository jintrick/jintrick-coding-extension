---
id: v1.3.0
status: implemented
created: 2026-02-17
fixed_commit: 
---

# Issue: Markdown Human Linter の刷新 (Pre-write & Interactive Edit)

## 概要
Markdown 書き込み時、提案内容を実ファイルに先行書き込みし、VSCode の `--wait` でユーザーに直接編集を許可する。編集後は `deny` を返すことでエージェントによる上書きを阻止し、ユーザーの修正を確定させる。

## 背景と問題点
現在の `md.cjs` は一時ファイルを使用しているため、VSCode 上で内容が白紙に見える「白紙問題」が発生している。また、`BeforeTool` フックで `allow` を返すと、ユーザーが VSCode で修正した内容がエージェントの当初の提案で上書きされ、消失してしまうという重大な課題がある。

## 解決策
1.  **先行書き込み (Pre-write)**: フック内でエージェントの提案内容をターゲットファイルに先に書き込み、VSCode で開いた瞬間に内容が表示されるようにする。
2.  **編集待機 (`code --wait`)**: ユーザーが保存してタブを閉じるまでフックをサスペンドし、目視確認と直接編集の時間を確保する。
3.  **上書き阻止 (`deny`)**: ユーザーがタブを閉じたら意図的に `deny` を返し、CLI 本体による自動上書き（＝ユーザー修正の破壊）を物理的にキャンセルする。
4.  **エージェントへの状況共有**: `deny` の理由として「ユーザーが最終確認と修正を完了した」ことを伝え、エージェントが次のタスクへ進めるようにする。

## 実装内容詳細

### 1. `hooks/scripts/linters/md.cjs` の修正
- `fs.writeFileSync` を使用して、`filePath` に `content` を直接書き込む。
- `execSync` で `code -w "${filePath}"` を実行する。
- 戻り値として `valid: false` と、状況を説明する `reason` / `systemMessage` を返す。

### 2. `hooks/scripts/linter_hook.cjs` の動作確認
- Linter から `valid: false` が返された際、`deny` が適切に CLI へ渡されることを確認する。

## ゴール
- [x] Markdown 書き込み時、VSCode で即座に提案内容が表示される。
- [x] VSCode での編集・保存内容が、エージェントの上書きによって消失しない。
- [x] エージェントが `deny` メッセージを読み、「ユーザーが手動で確定させた」ことを理解してタスクを継続できる。
