---
id: v1.5.2
status: in-progress
created: 2026-02-17
fixed_commit: 
---

# Issue: 人間可読ファイルの自動表示フックの完全分離、ビルド統合、およびマニフェスト適正化

## 概要
Markdown や設定ファイル (TOML 等) を VSCode で開く機能を `open_file_hook.cjs` として完全に独立させ、非ブロッキング化する。また、Hooks 設定の整合性を確保し、実機での確実な動作を担保する。

## 現状の課題
- **設計不備**: `linter_hook.cjs` にバリデーション以外の UI 責務が混在している。
- **規約違反**: `code -w` (待機) が Headless ポリシーに抵触している。
- **不整合**: `gemini-extension.json` と `hooks/hooks.json` のフック定義が整理されていない。
- **反映漏れ**: `hooks.json` の変更には CLI の再起動が必要であるという認識が検証計画から漏れている。

## 解決策
1.  **新規フック `open_file_hook.cjs` の実装**:
    - `AfterTool` 専用。`child_process.spawn` による非ブロッキング起動を実現。
    - 対象: `.md`, `.txt`, `.toml`, `.yaml`, `.yml`, `.env`, `.ini`, `.xml`。
2.  **既存フックの解体と整理**:
    - `linter_hook.cjs`: Markdown / UI 依存（`md.cjs` 関連）を完全に削除。
    - `hooks/scripts/linters/md.cjs`: 廃止・削除。
3.  **ビルドパイプラインの更新**:
    - `tools/build.cjs` に `open_file_hook.cjs` を追加し、`dist/hooks/` へバンドル。
4.  **設定ファイルの適正化**:
    - `hooks/hooks.json`: `BeforeTool` (linter) と `AfterTool` (open-file) を明確に分離。
    - `gemini-extension.json`: 実際の `dist/` 構造に合わせたフック定義に修正。

## 編集・削除対象ファイルの網羅
- `hooks/scripts/open_file_hook.cjs` (新規)
- `hooks/hooks.json` (修正)
- `gemini-extension.json` (修正)
- `hooks/scripts/linter_hook.cjs` (修正)
- `hooks/scripts/linters/md.cjs` (削除)
- `tools/build.cjs` (修正)
- `tests/hooks/linter_hook.test.js` (修正)
- `tests/hooks/open_file_hook.test.js` (新規)

## ゴール (検証要件)
- [ ] `dist/hooks/open_file_hook.cjs` がバンドル生成されている。
- [ ] `hooks/hooks.json` の定義が、新しい `dist/` パスを正しく指している。
- [ ] **CLI の完全な再起動** を行い、Markdown 作成時に VSCode が開き、かつエージェントが停止しないことを実機で確認済み。
- [ ] `linter_hook.cjs` のユニットテストが、MD 依存なしでパスしている。
- [ ] 新規 `open_file_hook.cjs` のテストがパスしている。
