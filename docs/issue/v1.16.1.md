---
id: v1.16.1
type: refactor
status: drafting
created: 2026-02-21
fixed_commit: 
---

# Issue: Python Linter の強化 (ast を用いた静的シンボル解析の導入)

## 概要
`hooks/scripts/linters/py.cjs` を刷新し、Python の `ast` モジュールを利用した静的解析を導入する。これにより、実行前に「インポート忘れ」や「未定義変数の参照」を検知し、AI エージェントによるコーディングミスを未然に防ぐ。

## 背景と問題点
- 現状の `py.cjs` は `compile()` による構文チェックのみを行っており、論理的なエラー（未定義変数の参照やインポート漏れ）を検知できない。
- AI エージェントが `math.sqrt()` を使用しながら `import math` を忘れるケースが頻発しており、これが手戻りの原因となっている。
- 外部ツール（flake8, ruff 等）に依存せず、標準ライブラリのみで軽量かつ確実に動作するバリデーションが必要である。

## 解決策

### 1. Python `ast` モジュールによる解析スクリプトの導入
`spawnSync` で実行する Python ワンライナーを、`ast.parse` と `ast.walk` を使用した解析スクリプトに置き換える。以下の 2 段階の解析を行う：
1. **シンボル収集**: `builtins` およびファイル内の全定義（Import, Function, Class, Assign, Arguments）をリストアップする。
2. **スコープ検証**: トップレベルおよび関数内部での名前の使用（Load）を、定義済みリストと照合する。

### 2. `builtins` の完全な除外
Python の `builtins` モジュールを動的に読み込み、`print`, `len`, `range` などの標準関数を正しく「定義済み」として扱う。また、`__name__` や `__file__` などの特殊属性も予約語として定義に含める。

## 実装内容詳細

### 1. `hooks/scripts/linters/py.cjs` の変更
`runPython` 関数内の `args` を変更し、以下のロジックを持つ Python スクリプトを標準入力から流し込む。

#### Python 側の解析ロジック（仕様）:
1.  **準備**: `import ast, sys, builtins` を実行。
2.  **パース**: `tree = ast.parse(sys.stdin.read())` を実行。`SyntaxError` はそのまま stderr に出力して `sys.exit(1)`。
3.  **定義済みセットの作成**:
    -   `defined_all = set(dir(builtins)) | {'__name__', '__file__', '__doc__', '__package__', '__loader__', '__spec__', '__annotations__'}`
    -   `defined_globals = set(defined_all)`
    -   `tree.body` を走査し、トップレベルの `Import`, `ImportFrom`, `FunctionDef`, `ClassDef`, `Assign`, `AnnAssign` から名前を抽出して `defined_globals` に追加する。
    -   `ast.walk(tree)` を実行し、ファイル内のすべての `Store` コンテキストを持つ `Name`, `arg`, およびすべての `FunctionDef/ClassDef` 名を `defined_all` に集約する。
4.  **名前の使用チェック (Two-Tier Check)**:
    -   `tree.body` の各ノード `node` に対して：
        -   `node` が `FunctionDef`, `ClassDef`, `AsyncFunctionDef` の場合：
            -   その配下（`ast.walk(node)`）の `Load` コンテキストを持つ `Name` が `defined_all` に含まれているか確認する。
        -   それ以外（トップレベルコード）の場合：
            -   その配下の `Load` コンテキストを持つ `Name` が `defined_globals` に含まれているか確認する。
5.  **エラー報告**: 未定義の名前が見つかった場合、`line {lineno}: name '{id}' is not defined` の形式で stderr に出力し、`sys.exit(1)` で終了する。

### 2. `systemMessage` の改善
エラー検知時、`systemMessage` に具体的な未定義名と行番号を含めるように `py.cjs` の戻り値を調整する。

## ゴール
### 完了条件 (Acceptance Criteria)
- [ ] **インポート忘れの検知**: `math.sqrt(2)` のみのコードが `deny` され、`math` が未定義である旨のエラーが出る。
- [ ] **未定義変数の検知**: `a = b + 1` (b 未定義) が `deny` される。
- [ ] **組み込み関数の許容**: `print(len("test"))` が `allow` される。
- [ ] **トップレベルスコープの保護**: 関数内で定義された `x = 1` を関数の外で `print(x)` した場合に `deny` される。
- [ ] **正常系の通過**: `import os; os.getcwd()` が `allow` される。
- [ ] **パフォーマンス**: `ast.walk` を使用し、大規模なファイルでも 1 秒以内に解析が完了する。
- [ ] **環境非依存**: Python 3.x の標準ライブラリのみを使用し、外部依存がない。

## 検証手順 (Test Steps)
1.  **単体テストの実行**:
    -   `tests/hooks/linter_hook.test.js` に上記の Acceptance Criteria に対応するテストケースを追加する。
    -   `npm test tests/hooks/linter_hook.test.js` を実行。
2.  **実ファイルでの検証**:
    -   意図的にインポートを抜いた `.py` ファイルを作成し、`linter_hook` が動作することを確認する。
