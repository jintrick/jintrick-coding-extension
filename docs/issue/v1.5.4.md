---
id: v1.5.4
type: fix
status: completed
created: 2026-02-17
fixed_commit: 7d6c260 
---

# Issue: BeforeTool 統合・一時ファイル方式による安全なプレビュー表示の復元

## 概要
AfterTool での `start` コマンド暴走を廃止し、v1.2.0 まで採用されていた「一時ファイル（temp）を作成して VSCode で表示する」方式を現代的に改善して復元する。これにより、エージェントを止めず、かつ Windows 環境でも安全に人間による目視レビューを可能にする。

## 背景と問題点
- **AfterTool 方式の失敗 (v1.5.3)**: v1.5.3 で導入した `AfterTool` + `start` 方式は、Windows のシェル仕様により大量の cmd.exe ウィンドウを発生させ、ユーザー体験を著しく損なった。
- **ブロッキング問題 (v1.3.0)**: v1.3.0 で導入された「実ファイル直接編集 (`code -w`)」方式は、エージェントがユーザーの保存を待機してしまい、非ブロッキングな開発を妨げていた。
- **設計の変遷と教訓**: 一時ファイル方式（v1.2.0）は「内容が白紙に見える」等の課題で一度は放棄されたが、現在の「AfterTool 暴走」や「ブロッキング」というより大きな問題を解決するためには、一時ファイル方式を非同期 spawn で改善して再導入するのが最適であると判断した。

## 解決策
1. **歴史的実装 (v1.2.0) の復元と改善**:
    - `v1.2.0` 時点の実装をベースに、`BeforeTool` 内でプレビュー用一時ファイルを作成するロジックを復元。
    - `execSync` ではなく `spawn` (detached: true) を使用することで、完全な非ブロッキング表示を実現。
2. **BeforeTool への一本化**:
    - `hooks/hooks.json` から `AfterTool` の定義を削除。
    - `linter_hook.cjs` から呼び出される `linters/md.cjs` 内にプレビュー表示ロジックをカプセル化。
3. **不要なファイルの整理**:
    - 不具合のあった `open_file_hook.cjs` を削除し、ビルドプロセスからも除外する。

## 実装内容詳細
- **`hooks/scripts/linters/md.cjs`**:
    - `os.tmpdir()` を使用して `preview_[timestamp]_[filename]` という一時ファイルを作成。
    - `fs.writeFileSync` で書き込み予定の内容を一時ファイルに保存。
    - `spawn('code', [tempFilePath], { detached: true, stdio: 'ignore' })` で VSCode を起動。
    - `child.unref()` でプロセスを完全に切り離す。
    - 常に `{ valid: true }` を返し、エージェントの本来の書き込み（BeforeTool → 本体処理）を妨げない。
- **`hooks/hooks.json`**: `AfterTool` セクションを空にする。
- **`tools/build.cjs`**: `open_file_hook.cjs` のビルドを停止。

## ゴール
- [ ] AfterTool による cmd.exe の暴走が完全に解消される。
- [ ] Markdown 書き込み時、VSCode で内容を確認できる一時ファイルが開き、かつエージェントが即座に次の動作（本体の書き込み完了）に移る。
- [ ] 実装が `md.cjs` に集約され、構成がシンプルになる。
