---
id: v1.2.0
status: in-progress
created: 2026-02-16
fixed_commit:
---

# Issue: gemini-cli-expert におけるドキュメントの自動更新

## 概要
`gemini-cli-expert` スキルは、`gemini-cli` リポジトリから抽出したドキュメントをリファレンスとして使用している。
現在は手動で更新しているが、これを任意のタイミング、またはドキュメントの更新を検知して自動で入れ替え、さらに `catalog.json` を更新する仕組みを導入したい。

## 課題
- ドキュメントの手動更新による手間の削減。
- 最新の CLI 仕様への迅速な追従。
- `catalog.json` の一貫性保持。

## 検討事項
- `gemini-cli` リポジトリの監視・取得方法。
- 抽出・置換ロジックの自動化。
- `catalog.json` の自動生成/更新フロー。

## ゴール
- [ ] `gemini-cli-expert` が起動されたタイミングで、自動的に最新のドキュメントを確認・取得できる。
- [ ] `catalog.json`（または `discovery.json`）が自動的に再生成され、新しく追加されたドキュメントも即座に検索対象に含まれる。
- [ ] 手動でのコピー＆ペースト作業を完全に排除する。

## 実装内容詳細

### 1. フックの構成 (`hooks/hooks.json`)
- `BeforeTool` 配下に、`activate_skill` 専用の新しいマッチャーグループを追加する。
- 既存の `write_file|replace` グループとは完全に分離し、不要なフック実行（スキップ処理のオーバーヘッド）を避ける。

```json
{
  "hooks": {
    "BeforeTool": [
      {
        "matcher": "write_file|replace",
        "hooks": [
          {
            "name": "linter-hook",
            "type": "command",
            "command": "node \"${extensionPath}${/}dist${/}hooks${/}linter_hook.cjs\"",
            "description": "ファイルの書き込み・置換前に構文エラーをチェックします。"
          }
        ]
      },
      {
        "matcher": "activate_skill",
        "hooks": [
          {
            "name": "expert-docs-hook",
            "type": "command",
            "command": "node \"${extensionPath}${/}dist${/}hooks${/}expert_docs_hook.cjs\"",
            "description": "gemini-cli-expert スキルの起動時にドキュメントを最新化します。"
          }
        ]
      }
    ]
  }
}
```

### 2. ドキュメント更新ロジック (`hooks/scripts/expert_docs_hook.cjs`)
- **実行判定ロジック**:
  - フック自体は `activate_skill` イベントで起動されるが、以下の条件をすべて満たす場合のみ更新処理を実行する。
    1. `tool_input.name` が `gemini-cli-expert` であること。
    2. `skills/gemini-cli-expert/references/discovery.json` の `metadata.updated_at` を確認し、前回の更新から 24 時間以上経過していること。
- **ドキュメント取得**:
  - `git clone --depth 1 https://github.com/google-gemini/gemini-cli.git` を一時ディレクトリ（`os.tmpdir()`）で実行する。
  - `gemini-cli/docs/` ディレクトリ配下の `.md` ファイルを、本プロジェクトの `skills/gemini-cli-expert/references/docs/` にコピー（同期）する。
- **`discovery.json` の再生成**:
  - 同期した Markdown ファイルを再帰的にスキャンする。
  - 各ファイルの 1 行目（`# Title`）を `title` として取得。
  - **サマリー抽出**: タイトル行を除いた本文から、最初の空行までのテキストブロックを抽出して `summary` とする。
  - `url` は `https://github.com/google-gemini/gemini-cli/blob/main/docs/` + 相対パスで生成。
  - **`metadata.updated_at` に現在のタイムスタンプ（ISO 8601）を記録**して、`skills/gemini-cli-expert/references/discovery.json` に上書き保存する。

### 3. ビルドと統合
- `build.js` に `hooks/scripts/expert_docs_hook.cjs` をエントリーポイントとして追加し、`dist/` へ出力するようにする。
- フック内でエラーが発生しても、`activate_skill` 自体はブロックしないように `{ decision: "allow" }` を常に返す（ただしエラー内容は stderr に出力する）。
