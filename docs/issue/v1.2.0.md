---
id: v1.2.0
status: done
created: 2026-02-16
fixed_commit: cd09fd2
---

# Issue: gemini-cli-expert ドキュメント更新通知機能 (BeforeTool Deny 方式)

## 概要
`gemini-cli-expert` スキルのドキュメント更新を検知した場合、初回起動を **BeforeTool フックで意図的にブロック（Deny）** し、ユーザーとエージェントに通知する。

## 背景と決定理由
本機能の実装にあたり、以下の3つのアプローチを検証した結果、最終的に `BeforeTool + Deny` を選択した。

1. **`BeforeTool` + `allow` + `systemMessage`**: 
   - 検証結果: 通知が他の出力に埋もれ、ユーザーもエージェントも更新に気づくことができなかった。
2. **`AfterTool` + `deny`**: 
   - 検証結果: スキルの読み込み（実行）自体は完了するが、その結果が破棄されるため、エージェントがスキルを使用できなくなる。挙動として不自然であり、リソースの無駄も多い。
3. **`BeforeTool` + `deny` + 詳細なガイダンス (採用)**:
   - 決定理由: `deny` を使うことで通知の視認性を 100% 確保できる。また、エージェントに対して「再試行すれば起動できる」という明確な回避策を伝えることで、利便性と安全性のバランスを最適化できると判断した。一度 `deny` されても、直後の再試行では24時間ルールにより確実に `allow` されるため、運用上のストレスも最小限に抑えられる。

## 課題
- 更新に気づかず古いドキュメントを使用し続けるリスク。
- エージェントがブロックの理由と回避策を理解できないと、不必要なトラブルシューティングを始めてしまう。

## 解決策
- フックイベントを **`BeforeTool`** に戻し、効率的に介入する。
- 更新検知時、**`decision: "deny"`** を返し、詳細なガイダンスを含むメッセージを表示する。
- メッセージには「再試行すれば起動可能であること」を含め、エージェントが自律的に再試行またはユーザーへの確認を行えるようにする。

## 実装内容詳細

### 1. フック構成 (`hooks/hooks.json`)
- `BeforeTool` 配下に `activate_skill` マッチャーで配置する。

### 2. フックロジック (`hooks/scripts/expert_docs_hook.cjs`)
- **トリガー**: `BeforeTool` (activate_skill)
- **ロジック**:
  1. 24時間間隔で GitHub API を実行し `docs/` の更新を確認。
  2. 更新がある場合、以下を返す：
     - `decision`: `"deny"`
     - `reason`: 「ドキュメント更新を検知しました。安全のため一度ブロックしましたが、このまま使用する場合は再度スキルを起動してください（次はチェックをスキップします）」という詳細な指示。
     - `systemMessage`: 上記と同じ内容の人間向けメッセージ。
  3. 更新がない、またはチェック不要（24時間以内）な場合は `decision: "allow"`。

## ゴール
- [x] ドキュメント更新時、適切なガイダンスと共に起動が一度阻止される。
- [x] エージェントがメッセージを読み、ユーザーに対して「更新があるが、このまま再試行して起動するか」を提案できる。
