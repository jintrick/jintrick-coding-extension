---
id: v1.2.0
status: in-progress
created: 2026-02-16
fixed_commit:
---

# Issue: gemini-cli-expert ドキュメント更新通知機能 (AfterTool Deny 方式)

## 概要
`gemini-cli-expert` スキルで使用しているドキュメントが更新された場合、スキル起動直後に **強制的な警告（Deny）** を行い、ユーザーとエージェントの両方に確実に通知する。

## 課題
- `allow` + `systemMessage` 方式では通知が他の出力に埋もれ、認識されないリスクが高い。
- 更新の事実を無視して古いドキュメントで作業を続けることを防ぐため、明示的な介入が必要。

## 解決策
- フックイベントを **`AfterTool`** とし、スキルのロードが終わった直後に介入する。
- 更新検知時、あえて **`decision: "deny"`** を返す。
- これにより、ツールの実行結果（巨大なXML）を「更新通知メッセージ」で上書きし、エージェントに「更新が必要であること」を強制的に認識させる。

## 実装内容詳細

### 1. フック構成 (`hooks/hooks.json`)
- `AfterTool` 配下に `activate_skill` マッチャーで配置。

### 2. フックロジック (`hooks/scripts/expert_docs_hook.cjs`)
- **トリガー**: `AfterTool` (activate_skill)
- **ロジック**:
  1. GitHub API を使用して `docs/` の最新コミット SHA を取得（24時間間隔）。
  2. ローカルの `commit_hash` と異なる場合、以下を返す：
     - `decision`: `"deny"`
     - `reason`: 更新通知メッセージ（エージェント向け）。
     - `systemMessage`: 更新通知メッセージ（人間向け）。
  3. 更新がない、またはチェック不要な場合は `decision: "allow"` を返す。

## ゴール
- [ ] ドキュメント更新時、スキル起動が「警告」によって中断（上書き）され、通知が確実に表示される。
- [ ] エージェントが更新の事実を前提にユーザーと会話できる。
