---
id: v1.5.1
status: in-progress
created: 2026-02-17
fixed_commit: 
---

# Issue: CI デプロイフローのホワイトリスト化と main ブランチの浄化

## 概要
現在の CI (`.github/workflows/deploy.yml`) は、dev ブランチの内容を全コピーした後、不要なディレクトリを `rm -rf` で削除する「ブラックリスト方式」を採用している。このため、削除対象から漏れたファイル（例: `docs/reference/gemini-cli-expert/`）が `main` ブランチに混入し続ける問題が発生している。

本 Issue では、CI を「必要なファイルのみを抽出してデプロイする」ホワイトリスト方式に変更し、`main` ブランチを常にクリーンな状態（純粋な配布アーティファクトのみ）に保つことを目指す。

## 現状の課題
- **不要ファイルの混入**: `docs/reference/` 配下の開発ドキュメントや外部リファレンスが `main` に残存している。
- **メンテナンス性**: 新しいファイルを追加するたびに `rm` コマンドを修正する必要があり、漏れが発生しやすい。
- **配布サイズ**: 不要なファイルが含まれることで、ユーザーがインストールするパッケージサイズが無駄に肥大化する。

## 解決策
1.  **CI ワークフローの刷新**:
    - 一時ディレクトリを作成する。
    - 配布に必要なファイル（`dist/`, `hooks/hooks.json`, `package.json`, `README.md`, `gemini-extension.json` 等）のみをコピーする。
    - その一時ディレクトリの内容を `main` ブランチとして強制プッシュする。
2.  **`main` ブランチの初期化**:
    - 一度 `main` ブランチを完全に空にし、新しい CI によって生成されたクリーンな内容で上書きする。

## 実装内容詳細

### `.github/workflows/deploy.yml`
- `Prepare distribution package` ステップを廃止。
- `Create artifact directory` ステップを新設し、以下のファイルをコピーする：
    - `dist/`
    - `hooks/hooks.json`
    - `gemini-extension.json`
    - `package.json`
    - `package-lock.json`
    - `README.md`
    - `LICENSE` (あれば)
- `Deploy to main branch` ステップで、上記ディレクトリの内容をルートとしてコミット・プッシュする。

## ゴール
- [ ] `main` ブランチには、拡張機能の動作に必要な最小限のファイルのみが存在する状態になる。
- [ ] `docs/` ディレクトリなどが `main` から完全に排除される。
- [ ] CI が成功し、正しくタグ付けとリリースが行われる。
