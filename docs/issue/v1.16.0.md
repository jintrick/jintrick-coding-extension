---
id: v1.16.0
type: feat
status: closed
created: 2026-02-21
fixed_commit: 
---

# Issue: linter_hook への Python (.py) および TSX (.tsx) サポートの追加

## 概要
`linter_hook` に Python と TSX の構文バリデーションを追加する。Python は `py_compile` モジュールを利用し、TSX は `typescript` モジュールの `ScriptKind.TSX` を指定してパースを行う。

## 背景と問題点
- 現状の `linter_hook` は JS/TS/JSON/MD のみを対象としており、Python (.py) や React TSX (.tsx) のファイル変更時に構文エラーを検知できない。
- AI エージェントがインデントミスの多い Python コードや、JSX 構文を含む TSX コードを出力した場合、書き込み後に実行時エラーが発生するリスクがある。
- `ts.cjs` は現在デフォルトの設定でパースしており、`.tsx` 特有の構文（`<tag>` 等）をエラーとして扱う可能性がある。

## 解決策

### 1. Python バリデーターの新規作成 (`py.cjs`)
- `child_process.spawnSync` を用いて、外部プロセスで Python の構文チェックを実行する。
- 実行コマンド: `python -m py_compile -` (標準入力からソースを読み込み、バイトコードを出力せずにチェックのみ行う)。
- `python` コマンドが `ENOENT` (ファイル未検出) の場合は `python3` を試行し、両方とも存在しない場合はバリデーションをスキップ (`allow`) する。

### 2. TSX バリデーターの追加と共通化 (`tsx.cjs`, `ts.cjs`)
- `hooks/scripts/linters/tsx.cjs` を作成し、`ts.cjs` を再利用するブリッジとして機能させる。
- `ts.cjs` を更新し、`filePath` の拡張子が `.tsx` の場合に `ts.ScriptKind.TSX` を明示的に指定して `createSourceFile` を呼び出す。

### 3. フック本体の更新 (`linter_hook.cjs`)
- `supportedExtensions` に `.py` と `.tsx` を追加。

## 実装内容詳細

### 1. `hooks/scripts/linter_hook.cjs` の変更
- `supportedExtensions` 配列を更新する。
  - `const supportedExtensions = ['.js', '.cjs', '.mjs', '.ts', '.tsx', '.json', '.md', '.py'];`

### 2. `hooks/scripts/linters/py.cjs` の新規作成
- 以下のロジックを厳密に実装する：
  1. `spawnSync('python', ['-m', 'py_compile', '-'], { input: content, encoding: 'utf8', timeout: 5000, shell: false })` を実行。
  2. `result.error && result.error.code === 'ENOENT'` の場合、`python3` で再試行。
  3. それでも `ENOENT` の場合、`{ valid: true }` を返し、`process.stderr.write` でスキップした旨を出力する。
  4. `result.status !== 0` の場合、`{ valid: false, reason: 'Python Syntax Error', systemMessage: '...' }` を返す。`systemMessage` には `result.stderr` を含める。
  5. 成功時は `{ valid: true }` を返す。

### 3. `hooks/scripts/linters/ts.cjs` の変更
- `ts.createSourceFile` の第5引数に `scriptKind` を渡すように変更。
  - `const isTSX = filePath.endsWith('.tsx');`
  - `const scriptKind = isTSX ? ts.ScriptKind.TSX : ts.ScriptKind.TS;`
  - `ts.createSourceFile(filePath, content, ts.ScriptTarget.Latest, true, scriptKind)` として呼び出す。

### 4. `hooks/scripts/linters/tsx.cjs` の新規作成
- 以下の 1 行のみを記述する。
  - `module.exports = require('./ts.cjs');`

### 5. `tests/hooks/linter_hook.test.js` へのテスト追加
- **Python テストケース**:
  - 正しいコード (`print("hello")`) -> `allow`
  - 構文エラー (`print("hello"`) -> `deny`
  - インデントエラー (`def f():\nprint(1)`) -> `deny`
- **TSX テストケース**:
  - 正しい TSX (`const App = () => <div>Hello</div>;`) -> `allow`
  - タグ閉じ忘れ (`const App = () => <div>Hello;`) -> `deny`

## ゴール
- [ ] `npm test` を実行し、既存および新規のテストケース（Python, TSX）がすべてパスすること。
- [ ] `python` がインストールされていない環境でも、`.py` ファイルの書き込みがブロックされないこと（スキップされること）。
- [ ] `.tsx` ファイルで JSX 構文が正しく許容されること。
- [ ] `npm run build` により `dist/` の成果物が更新されること。
