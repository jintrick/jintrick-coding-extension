# v1.18.0: Python Linter のエラー報告詳細化と自己修正フローの確立

## 1. 概要 (Overview)
JavaScript (`js.cjs`) 等の他の Linter と比較して、Python Linter (`py.cjs`) だけが構文エラー時に詳細な情報（行番号、メッセージ）をエージェントに返却しておらず、自己修正が困難である問題を解決する。

## 2. 背景 (Background)
- **不均衡な品質**: `js.cjs` は `acorn` のエラー詳細（行番号、メッセージ）を `reason` フィールドに含めているが、`py.cjs` は単に `'Python Syntax Error'` という固定文字列しか返していない。
- **外部プロセスの制約**: Python Linter は `spawnSync` で外部プロセスを実行しているため、エラー詳細を `stderr` から取得し、それを適切に `reason` に流し込む必要があるが、現在は無視されている。

## 3. 解決策 (Solution)
1.  **`LINTER_SCRIPT` の強化**: Python 側の `SyntaxError` ハンドリングにおいて、`e.msg`, `e.lineno`, `e.offset`, `e.text` を抽出し、詳細なエラー情報を `stderr` に出力するように修正する。
2.  **`reason` フィールドへの詳細注入**: `py.cjs` において、`result.stderr` を `reason` フィールドに含めるように変更し、`js.cjs` と同等の情報量（ファイルパス、行番号、エラー理由）を提供する。
3.  **UI 表示の維持**: 従来通り、`systemMessage` にも詳細を含め、ユーザー（人間）にも情報が伝わるようにする。

## 4. 詳細 (Details)

### 4.1 `hooks/scripts/linters/py.cjs`
- `LINTER_SCRIPT` 内で `SyntaxError` をキャッチした際、以下の形式で出力する。
    - `SyntaxError: <msg> (line <lineno>, offset <offset>)`
    - `<line_text>`
    - `<caret_position>^`
- `validate` 関数内での返却値（JSの実装に合わせる）：
    ```javascript
    return {
      valid: false,
      reason: `Python Syntax Error in ${filePath}: ${result.stderr.trim()}`,
      systemMessage: `🚫 Python Syntax Error: ${tool_name} で書き込もうとした ${filePath} にエラーがあります。\n${result.stderr}`
    };
    ```

## 5. ゴール (Goal / Checklist)
- [ ] 構文エラーを含む Python ファイルを `write_file` 試行した際、エージェントが詳細なエラー内容（行番号、メッセージ）を含むレスポンスを受け取る。
- [ ] `js.cjs` 等の他の Linter と同等のエラー報告品質が担保される。
- [ ] ユーザーのターミナルにも詳細なエラーメッセージが表示される。

## 6. 検証 (Verification)
- `tests/exp/broken.py` を作成し、`node dist/hooks/linter_hook.cjs` を直接叩いて、出力される JSON の `reason` フィールドを確認する。
- `npm test` による既存テストの通過。
