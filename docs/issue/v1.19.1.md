---
id: v1.19.1
type: fix
status: completed
created: 2026-02-25
fixed_commit: 13b6b6c5d32e817662585758e412885d736147b3
---

# Issue: `linter_hook.cjs` における `replace` ツール複数置換の正確な再現と特殊文字エスケープの修正

## 概要
`linter_hook.cjs` が `replace` ツールの動作をシミュレートしてバリデーション対象コンテンツを再構成する際、JavaScript の `String.prototype.replace` の仕様により「最初の1箇所しか置換されない」および「置換後の文字列内の `$` が特殊記号として解釈される」不具合を修正する。これにより、`md.cjs` のプレビュー精度を向上させ、全言語の Linter で「全置換後の正しい状態」を検証可能にする。

## 背景と問題点
1.  **複数置換への不対応**: 現在の `linter_hook.cjs` は `currentContent.replace(old, new)` を使用している。第1引数が文字列の場合、最初の1箇所しか置換されないため、`expected_replacements` を指定した全置換のシミュレーションが不完全。
2.  **置換文字列内の特殊文字問題**: JS の `.replace(pattern, replacementString)` において、`replacementString` 内の `$` は特殊な意味（`$&`, `$1` 等）を持つ。Gemini CLI の `replace` ツールは純粋なリテラル置換を期待しているため、コード内に `$` が含まれると意図しない破損が発生する。
3.  **プレビューの不正確性**: `md.cjs` はフックから渡された再構成コンテンツを表示するが、上記の理由により「1箇所しか変わっていない」「`$` が化けている」プレビューが表示され、エージェントが置換に失敗したと誤認する原因となる。

## 解決策
1.  **正規表現エスケープの導入**: `old_string` を正規表現として扱う前に、すべての正規表現メタ文字をエスケープするヘルパー関数を追加する。
2.  **グローバル置換の適用**: `expected_replacements` が指定されている場合、`g` フラグを付けた正規表現を使用して全置換を実行する。
3.  **リテラル置換の保証**: `.replace()` の第2引数に文字列ではなくアロー関数 `() => new_string` を渡すことで、JS による `$` の解釈を無効化し、完全なリテラル置換を実現する。
4.  **検証用テストの拡充**: `replace` ツールの挙動に特化したテストケースを新規作成し、複数置換と特殊文字（`$`, `*`, `()`, `[]` 等）が正しく処理されることを保証する。

## 実装内容詳細

### 1. `hooks/scripts/linter_hook.cjs` の修正
- ファイル冒頭に以下のヘルパー関数を追加：
  ```javascript
  function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }
  ```
- `tool_name === 'replace'` ブロックのロジックを以下のように更新：
  - `tool_input` から `expected_replacements` を取得する。
  - `old_string`, `new_string` を改行コード正規化 (`\n`) する。
  - `expected_replacements` が `undefined` 以外（明示的に指定されている）の場合は、グローバル置換を行う：
    ```javascript
    const regex = new RegExp(escapeRegExp(normalizedOld), 'g');
    contentToValidate = normalizedContent.replace(regex, () => normalizedNew);
    ```
  - `expected_replacements` が未指定の場合は、最初の1箇所のみ置換する（既存のデフォルト挙動の維持）：
    ```javascript
    contentToValidate = normalizedContent.replace(normalizedOld, () => normalizedNew);
    ```
  - ※ いずれの場合も第2引数は `() => normalizedNew` とすること。

### 2. `tests/hooks/linter_hook_replace.test.js` の新規作成
以下のシナリオをテストする：
- **正常系（単一置換）**: `expected_replacements` なしで、最初の1箇所が置換されること。
- **正常系（複数置換）**: `expected_replacements: 2` で、2箇所の出現場所すべてが置換されること。
- **エスケープ（検索語）**: `old_string` に `if (a > 0) {` などの記号が含まれていても正しくマッチすること。
- **エスケープ（置換語）**: `new_string` に `const $price = 100;` などの `$` が含まれていても、`$$` に化けずにそのまま置換されること。
- **Markdown プレビュー連携**: Markdown ファイルに対して `replace` を行った際、`stderr` にプレビュー作成ログが出力されること。

## ゴール
- `replace` ツール実行時、`expected_replacements` の有無に関わらず、Gemini CLI の実際の動作と一致するコンテンツが再構成される。
- `md.cjs` で表示されるプレビュー内容が、実際にファイルに書き込まれる内容と 100% 一致する。
- 置換文字列に `$` が含まれていても、意図した通りのコードが生成・検証される。
- 新設したテストスイート `linter_hook_replace.test.js` がすべてパスする。
