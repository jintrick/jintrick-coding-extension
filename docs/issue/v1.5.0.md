---
id: v1.5.0
status: in-progress
created: 2026-02-17
fixed_commit: 
---

# Issue: Markdown Hook の AfterTool 移行と Linter Hook の統合管理

## 概要
v1.3.0 で導入した Markdown フックの「先行書き込み + BeforeTool + deny」というハック的な実装を廃止し、Gemini CLI の正規のライフサイクルである `AfterTool` に移行する。また、`linter_hook.cjs` が `BeforeTool` と `AfterTool` の両方で適切に振る舞うようロジックを整理する。

## 現状の課題
- **不自然な副作用**: `BeforeTool` 内で自らファイル書き込みを行っており、CLI 本体のチェックポイント機能や履歴管理と整合性が取れていない。
- **状態の不一致**: 実際には書き込みに成功しているのに、エージェントには `deny`（拒否）として伝わるため、エージェントが混乱する可能性がある。
- **メンテナンス性**: `linter_hook.cjs` が MD の特殊な挙動（VSCode 待機）を `BeforeTool` で無理やり処理しており、他の言語のバリデーションと設計思想が混在している。

## 解決策
1.  **イベントの分離**:
    *   **BeforeTool**: JS/TS/JSON などの自動バリデーションを実行。不正な書き込みを「未然に防ぐ」。
    *   **AfterTool**: Markdown の人間レビューを実行。CLI 本体の「書き込み後に確認・修正」する。
2.  **Linter Hook の知能化**:
    *   `hook_event_name` を見て、適切なタイミングで各言語の Linter を呼び出すようにする。
3.  **Markdown レビューの洗練**:
    *   先行書き込みコードを削除。
    *   ユーザーが編集した結果を `additionalContext` でエージェントにフィードバックし、`deny`（結果置換）によって成功メッセージを「ユーザーが確認済み」というより強い確証に置き換える。

## 実装内容詳細

### 1. `hooks/hooks.json`
- `AfterTool` イベントを追加し、`write_file` および `replace` を対象に `linter_hook.cjs` を設定。

### 2. `hooks/scripts/linter_hook.cjs`
- `input.hook_event_name` による分岐ロジックを追加。
- `BeforeTool` 時は `.md` をスキップ。
- `AfterTool` 時は `.md` のみ処理。

### 3. `hooks/scripts/linters/md.cjs`
- `fs.writeFileSync` を削除。
- 戻り値に `hookSpecificOutput.additionalContext` を含める。

## ゴール
- [ ] Markdown のレビューが、CLI 本体の書き込み完了後に VSCode で開かれる。
- [ ] VSCode での編集内容が正しく保存され、エージェントにその旨が伝わる。
- [ ] JS/TS/JSON の構文チェックは引き続き書き込み前に機能し、不正なコードをブロックする。
- [ ] すべてのテストがパスし、実機で意図通りの挙動が確認できる。
