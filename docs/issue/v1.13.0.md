---
id: v1.13.0
type: feat
status: drafting
created: 2026-02-21
fixed_commit: 
---

# Issue: Command Fixer Hook によるシェルコマンド自動置換の導入

## 概要
Windows (PowerShell 5.1) 環境での互換性を確保するため、`run_shell_command` ツール実行前に、コマンド内の `&&` を `;` に自動置換する Hook を導入する。

## 背景と問題点
1. **環境制約**: PowerShell 5.1 では `&&` 演算子がサポートされていない。
2. **エージェントの誤使用**: 指示に関わらず、エージェントが `git add . && git commit` 等のコマンドを生成し、実行に失敗するケースが頻発している。
3. **自動修正の必要性**: 人手による修正や再生成は効率を低下させるため、システム側で機械的に置換を行う。

## 解決策
`BeforeTool` イベントにおいて `run_shell_command` をインターセプトし、その `command` 引数を書き換える Hook を実装する。Gemini CLI の `hookSpecificOutput.tool_input` 仕様を活用し、実行直前のパラメータをオーバーライドする。

## 実装内容詳細

### 1. フックロジックの実装
- **ファイルパス**: `hooks/scripts/command_fixer_hook.cjs`
- **入力**: `stdin` から `BeforeTool` イベントの JSON を受信。
- **処理**:
  - `tool_name` が `run_shell_command` であることを確認。
  - `tool_input.command` 文字列内の ` && ` (前後にスペースを含む) を `; ` に置換する。
- **出力**: `stdout` に以下の JSON を出力。
  ```json
  {
    "decision": "allow",
    "hookSpecificOutput": {
      "tool_input": {
        "command": "置換後の文字列"
      }
    }
  }
  ```

### 2. フックの登録
- **ファイルパス**: `hooks/hooks.json`
- **設定内容**:
  ```json
  {
    "matcher": "run_shell_command",
    "hooks": [
      {
        "name": "command-fixer-hook",
        "type": "command",
        "command": "node \"${extensionPath}${/}dist${/}hooks${/}command_fixer_hook.cjs\"",
        "description": "Windows環境向けにコマンド内の && を ; に自動置換します。"
      }
    ]
  }
  ```

### 3. ビルド設定の更新
- **ファイルパス**: `tools/build.cjs`
- **変更内容**: `entryPoints` に `hooks/scripts/command_fixer_hook.cjs` を追加し、`dist/hooks/command_fixer_hook.cjs` としてバンドルされるようにする。

## ゴール
- [ ] `run_shell_command` 実行時に `git add . && git commit` が `git add . ; git commit` として実行されること。
- [ ] `hooks/hooks.json` に正しく登録されていること。
- [ ] `npm run build` により `dist/hooks/command_fixer_hook.cjs` が生成されること。
- [ ] 自動テスト（モック入力）により置換ロジックの正当性が検証されていること。
