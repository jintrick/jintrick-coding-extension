---
id: v1.17.0
type: refactor
status: closed
created: 2025-02-17
fixed_commit: 
---

# Issue: v1.17.0 - Replace 'code' with configurable editor in md.cjs

## 概要
`hooks/scripts/linters/md.cjs` において、プレビュー用エディタとして `'code'` がハードコーディングされている箇所を、環境変数によるオーバーライドに対応した動的なコマンド指定に変更する。デフォルトのエディタを `'antigravity'` に更新し、既存の Windows 互換性（`shell: true`, `detached: true`）を完全に維持する。

## 背景と問題点
- 現在、Markdown の目視確認（Human Linter）に使用されるエディタが `'code'` (VS Code) に固定されている。
- プロジェクトの標準エディタが `antigravity` へ移行しつつあり、デフォルト動作をこれに合わせる必要がある。
- ユーザーが任意のエディタ（`vim`, `notepad`, `cursor` 等）を使用したい場合に、環境変数で柔軟に切り替える手段がない。
- ハードコーディングされた `'code'` は、VS Code がインストールされていない環境や、別のエディタを優先したい環境での利用を妨げている。

## 解決策
1. `md.cjs` 内で、以下の優先順位に従ってエディタコマンド（`editorCommand`）を決定するロジックを導入する：
   - `process.env.GEMINI_EDITOR`
   - `process.env.VISUAL`
   - `process.env.EDITOR`
   - デフォルト値: `'antigravity'`
2. `spawn` の第 1 引数を、固定値 `'code'` から `editorCommand` 変数に置き換える。
3. `spawn` のオプション（`detached: true`, `stdio: 'ignore'`, `shell: true`）および `child.unref()` の呼び出しを維持し、Windows 環境での非ブロッキング動作を保証する。

## 実装内容詳細

### 1. `hooks/scripts/linters/md.cjs` の修正
- ファイル冒頭の JSDoc コメントにあるバージョン情報を `v1.6.1` から `v1.17.0` に更新する。
- `spawn` 呼び出しの直前で、エディタコマンドを決定するロジックを追加する。
- `spawn` の実行部分で、決定されたコマンド変数を使用する。

**具体的なコード変更イメージ:**
```javascript
/**
 * Markdown "Human Linter" Module (v1.17.0 - Non-blocking Safe Spawn)
 * ...
 */
module.exports = function(content, filePath, tool_name) {
  try {
    // ... 一時ファイル作成ロジック ...

    // エディタコマンドの決定 (優先順位: GEMINI_EDITOR > VISUAL > EDITOR > antigravity)
    const editor = process.env.GEMINI_EDITOR || process.env.VISUAL || process.env.EDITOR || 'antigravity';

    // 指定されたエディタで一時ファイルを開く (spawn detached)
    // Windows/Unix 共通で shell: true を使用
    const child = spawn(editor, [tempFilePath], {
      detached: true,
      stdio: 'ignore',
      shell: true
    });
    child.unref();

    process.stderr.write(`[Human Linter] Preview created: ${tempFilePath} (Editor: ${editor})\n`);
  } catch (error) {
    process.stderr.write(`[MD Linter] Failed: ${error.message}\n`);
  }
  // ...
};
```

### 2. ビルドと確認
- `npm run build` を実行し、`dist/` への反映を確認する。
- 実際の動作確認は以下のパターンで行う：
  - 環境変数なし：`antigravity` の起動試行を確認。
  - `GEMINI_EDITOR=notepad`：Windows のメモ帳（または PATH にある notepad）が起動することを確認。

## ゴール
- [ ] `hooks/scripts/linters/md.cjs` 内から `'code'` の文字列（ハードコード）が排除されている。
- [ ] 環境変数 `GEMINI_EDITOR` で指定したコマンドが優先的に実行される。
- [ ] 環境変数が未設定の場合、デフォルトの `antigravity` コマンドが使用される。
- [ ] `spawn` 時に `shell: true` と `detached: true` が設定されており、エディタ起動後に CLI がブロックされない。
- [ ] `npm run build` が正常に完了する。
