---
id: v1.18.2
type: fix
status: fixed
created: 2025-01-24
fixed_commit: d6acf55ea4b47038ca7262c0be8b5b2ed5f1cdb5
---

# Issue: Python Linter の stderr 文字化け修正 (UTF-8強制モード導入)

## 概要
Windows 環境 (win32) において、Python Linter が stderr に出力するメッセージ（構文エラー等）がシステムデフォルトのエンコーディング (CP932) で出力されるため、Node.js 側で UTF-8 としてデコードする際に文字化けが発生している。これを修正するために、Python 起動時に UTF-8 モードを強制する環境変数を注入する。

## 背景と問題点
- **現状**: `v1.18.1` で `stdin` の UTF-8 デコードを Python スクリプト内で明示的に行ったが、Python 自身の `stderr` 出力（`SyntaxError` 時のメッセージや `print(..., file=sys.stderr)`）は依然としてオペレーティングシステムのデフォルトエンコーディング（Windows では CP932）を使用している。
- **影響**: 日本語を含むコードで構文エラーが発生した場合、エラーメッセージに含まれる当該行の日本語が文字化けし、ユーザーや AI エージェントがエラー内容を正確に把握できない。
- **原因**: Node.js の `spawnSync` で `encoding: 'utf8'` を指定して出力を受け取っているが、出力元（Python）が CP932 で書き込んでいるため、バイト列が壊れた状態で UTF-8 として解釈される。

## 解決策
1. `hooks/scripts/linters/py.cjs` の `spawnSync` 実行時に、以下の環境変数を注入する：
   - `PYTHONUTF8=1`: Python 3.7+ で導入された UTF-8 Mode を有効化し、標準 I/O およびファイル I/O を UTF-8 に強制する。
   - `PYTHONIOENCODING=utf-8`: 互換性のために標準 I/O エンコーディングを明示的に UTF-8 に設定する。
2. `process.env` を継承することで、`PATH` などの重要な環境変数を維持し、インタープリタの起動失敗を防ぐ。

## 実装内容詳細

### 1. `hooks/scripts/linters/py.cjs` の修正
`runPython` 関数内の `spawnSync` オプションに `env` を追加する。

```javascript
    const runPython = (cmd) => {
      return spawnSync(cmd, ['-c', LINTER_SCRIPT], {
        input: content,
        encoding: 'utf8',
        timeout: 5000,
        shell: false,
        env: {
          ...process.env,
          PYTHONUTF8: '1',
          PYTHONIOENCODING: 'utf-8'
        }
      });
    };
```

## ゴール
- [x] Windows 環境において、日本語を含む Python コードの構文エラーメッセージが文字化けせずに表示される。
- [x] `PYTHONUTF8=1` および `PYTHONIOENCODING=utf-8` が `spawnSync` に正しく渡されている。
- [x] `tests/hooks/python_linter_encoding.test.js` がパスする。

## 検証結果
- `tests/exp/invalid_utf8.py` を用いた実機検証により、`name 'ほげふが' is not defined` などの日本語エラーメッセージが文字化けせずに表示されることを確認。
- `npm test tests/hooks/python_linter_encoding.test.js` および `tests/hooks/python_linter.test.js` がすべてパス。
